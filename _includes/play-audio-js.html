<script>
  document.addEventListener("DOMContentLoaded", () => {
      const audioPlayer = document.getElementById("audio-player");
      const playPauseBtn = document.getElementById("play-pause-btn");
      const progressBar = document.querySelector(".progress-bar");
      const currentTimeDisplay = document.getElementById("current-time");
      const durationDisplay = document.getElementById("duration");

      // Устанавливаем путь к аудиофайлу
      const permalink = "{{ page.permalink }}";
      const source = audioPlayer.querySelector("source");
      source.src = `/assets/audio${permalink}.mp3`;
      audioPlayer.load();

      // Обработчик загрузки метаданных
      audioPlayer.addEventListener("loadedmetadata", () => {
          const currentMinute = new Date().getMinutes();
          audioPlayer.currentTime = currentMinute * 60;
          durationDisplay.textContent = formatTime(audioPlayer.duration);
      });

      // Функция переключения воспроизведения
      function togglePlayPause() {
          if (audioPlayer.paused) {
              audioPlayer.play().catch(error => {
                  console.error("Автозапуск блокирован:", error);
              });
              playPauseBtn.classList.remove("paused");
              playPauseBtn.classList.add("playing");
          } else {
              audioPlayer.pause();
              playPauseBtn.classList.remove("playing");
              playPauseBtn.classList.add("paused");
          }
      }

      // Устанавливаем начальное состояние кнопки
      playPauseBtn.classList.add("paused");

      // Обработчики событий
      playPauseBtn.addEventListener("click", togglePlayPause);
      document.addEventListener("keydown", (event) => {
          if (event.code === "Space") {
              event.preventDefault();
              togglePlayPause();
          }
      });

      // Обновление прогресс-бара
      audioPlayer.addEventListener("timeupdate", () => {
          if (audioPlayer.duration) {
              const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
              progressBar.style.width = `${progressPercent}%`;
              currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
          }
      });

      // Форматирование времени
      function formatTime(seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins}:${secs < 10 ? '0' + secs : secs}`;
      }

      // Убираем автоматическое воспроизведение при движении мыши
      let autoPlayDisabled = true;
      document.addEventListener("mousemove", () => {
          if (autoPlayDisabled) {
              autoPlayDisabled = false;
          }
      });
  });
</script>
